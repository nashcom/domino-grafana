# domino-grafana

Domino Grafana & Loki

Grafana is a powerful widely used open source solution for visualizing statics and logs.  
This repository is intended to provide the basic functionality to collect statistics and logs from HCL Domino.

The current development focus is Domino on Linux including containers.  
But the servertask is also available on Windows and there is an exporter project for Windows as well.

## Garafana and Prometheus components

There are multiple components involved on the Grafana stack side in an integration.  
On first glance it looks like a lot of moving parts.  
But this project contains all the scripts and glue to make them work together in an easy to setup stack.

- [Grafana](https://grafana.com/oss/grafana/) itself is the visual representation and dashboarding component
- [Prometheus](https://grafana.com/oss/prometheus/) stores statistics data from servers providing a data source for Grafana
- [Prometheus Node Exporter for Linux](https://prometheus.io/docs/guides/node-exporter/) presents stats in a Prometheus compatible format to be collected by Prometheus on a defined endpoint
- [Windows Exporter](https://github.com/prometheus-community/windows_exporter) presents Windows stats and is a Prometheus community project
- [Grafana Loki](https://grafana.com/oss/loki/) stores log data from servers providing data source for Grafana
- [Promtail](https://grafana.com/docs/loki/latest/send-data/promtail/) is the data collecting component sending logs to Loki


## Challenge to export stats from Domino

In contrast to the existing [Domino Stats Publishing](https://help.hcltechsw.com/domino/14.0.0/admin/stats_publish_other_external.html) functionality based on a **push model** (initially introduced for New Relic integration in Domino 10)
Prometheus expects data being collected from a server using a **pull model**.

In addition the statistics names have to be in a specific [Prometheus format](https://prometheus.io/docs/concepts/data_model/).  
Basically **only alphanumeric chars** and the **underscore** can be used.


## Domino Prometheus log exporter (domprom)

This leads to a small add-on component available for Linux and Windows.  
**domprom** is a small C-API based servertask, collecting all LONG and NUMBER statistics from the Domino server to present them in a file on disk with Prometheus compatible metrics names.
Specially the dots in the names of Domino statistics need to be converted to underscores.

The exported stats are written to a file on disk, which can be included in an existing log collection.
The **Node Exporter** on Linux allows to include additional `*.prom` files.
Those log files could be also presented via Domino HTTP directory on Windows or leveraging any other solution like [NGINX](https://www.nginx.com/).


## Setup metrics collection on Linux with node_exporter

[Prometheus Node Exporter for Linux](https://prometheus.io/docs/guides/node-exporter/) is a native for Linux OS level metrics.
It is a single binary available on [GitHub](https://github.com/prometheus/node_exporter), which should run on the host level to collect all relevant Linux statistics.

The **node_exporter** can be configured to send additional log files, which is the best choice for Domino metrics collection on Linux to ensure metrics are in-line between the OS and Domino.
The file generated by **domprom** can just be included and is send along with the Linux level stats.

See the setup and systemd scripts in [/exporter](/exporter/README.md) for details.


## Setup metrics collection on Windows with node_exporter

[Windows Exporter](https://github.com/prometheus-community/windows_exporter) is a native for Linux OS level metrics.
It is a single binary available on [GitHub](https://github.com/prometheus-community/windows_exporter/releases), which should run on the host level to collect all relevant Windows statistics.

The **Windows Exporter** can be configured to send additional log files, which is the best choice for Domino metrics collection on Windows to ensure metrics are in-line between the OS and Domino.

## TLS Setup

NGINX is expecting the certificate and key in

- **/local/certs/cert.pem** certficate chain including root
- **/local/certs/key.pem** private key


## Location of data

By default the following directories are used for native volumes

- /local/grafana-data
- /local/loki-data
- /local/prometheus-data

## Special notes for SELinux

When copying files the files might have the wrong security context even located in the right directory.
Relabeling the binary should help:

Example:

```
/usr/sbin/restorecon -v /usr/local/bin/node_exporter
```

The install script runs the relabeling if **restorecon** is installed.


## Setup log collection with Promtail for Loki

**promtail** is available for Linux and Windows to send logs to Loki over via push functionality.  
Prodmail is also a single binary available on [GitHub](https://github.com/grafana/loki).

See the setup and systemd scripts in [/exporter](/exporter/README.md) for details.


## Grafana Dashbaord

The primary goal of this project is to provide the tooling to collect the metrics and logs from Domino.  
But of course it would make sense to also provide components to reuse in dashboards  
It would also make sense to provide a basic Domino dashboard in the official [Grafana Dashboard catalog](https://grafana.com/grafana/dashboards/)

The best starting point for a Domino on Linux dashboard would be begin with the [Node Exporter Full Dashboard](https://grafana.com/grafana/dashboards/1860-node-exporter-full/).
A good way is to copied the dashboard and added Domino statistics to it from the same data source.

The dashboard is also an excellent example to learn building dashboards.

To get the dashboard installed, enter the dashboard URL or the number of the dashboard which is **1860**

There is also a [Windows Node Exporter Dashboard](https://grafana.com/grafana/dashboards/14499-windows-node/) which is using the Windows Exporter in a similar way.

## First Login to Grafana

The default user and password is **admin/admin** and should be changed immediately.
Once the server is started, log into the portal. The GUI prompts to change the password.


